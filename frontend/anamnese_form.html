<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Anamnese</title>
    <link rel="stylesheet" href="./css/styles.css" />
    <link rel="stylesheet" href="./css/dashboard.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet" />
</head>
<body>
    <div class="avaliacao-container">
        <h2>Anamnese</h2>
        <form id="anamneseForm" class="avaliacao-grid">
            <div class="form-field">
                <label for="email">Endereço de e-mail</label>
                <input id="email" type="email" name="email" placeholder="Endereço de e-mail" />
            </div>
            <div class="form-field">
                <label for="nome">Nome</label>
                <input id="nome" type="text" name="nome" placeholder="Nome" />
            </div>
            <div class="form-field">
                <label for="idade">Idade</label>
                <input id="idade" type="number" name="idade" placeholder="Idade" />
            </div>
            <div class="form-field">
                <label for="genero">Gênero</label>
                <input id="genero" type="text" name="genero" placeholder="Gênero" />
            </div>
            <div class="form-field">
                <label for="objetivos">Objetivos</label>
                <textarea id="objetivos" name="objetivos" placeholder="Objetivos"></textarea>
            </div>
            <div class="form-field">
                <label for="doencas">Já teve ou tem alguma doença? Se sim, quais?</label>
                <textarea id="doencas" name="doencas" placeholder="Já teve ou tem alguma doença? Se sim, quais?"></textarea>
            </div>
            <div class="form-field">
                <label for="doencasFamilia">Alguém da família tem alguma doença? Se sim, quais?</label>
                <textarea id="doencasFamilia" name="doencasFamilia" placeholder="Alguém da família tem alguma doença? Se sim, quais?"></textarea>
            </div>
            <div class="form-field">
                <label for="medicamentos">Faz uso de medicamentos? Quais?</label>
                <textarea id="medicamentos" name="medicamentos" placeholder="Faz uso de medicamentos? Quais?"></textarea>
            </div>
            <div class="form-field">
                <label for="cirurgias">Já passou por cirurgias? Quais?</label>
                <textarea id="cirurgias" name="cirurgias" placeholder="Já passou por cirurgias? Quais?"></textarea>
            </div>
            <div class="form-field">
                <label for="doresLesoes">Possui dores ou lesões?</label>
                <textarea id="doresLesoes" name="doresLesoes" placeholder="Possui dores ou lesões?"></textarea>
            </div>
            <div class="form-field">
                <label for="limitacoes">Alguma limitação para exercícios físicos?</label>
                <textarea id="limitacoes" name="limitacoes" placeholder="Alguma limitação para exercícios físicos?"></textarea>
            </div>
            <div class="form-field">
                <label for="fuma">Você Fuma?</label>
                <input id="fuma" type="text" name="fuma" placeholder="Você Fuma?" />
            </div>
            <div class="form-field">
                <label for="bebe">Você Bebe? Se sim, com qual frequência?</label>
                <input id="bebe" type="text" name="bebe" placeholder="Você Bebe? Se sim, com qual frequência?" />
            </div>
            <div class="form-field">
                <label for="qualidadeSono">Qualidade do sono</label>
                <input id="qualidadeSono" type="text" name="qualidadeSono" placeholder="Qualidade do sono" />
            </div>
            <div class="form-field">
                <label for="horasSono">Horas de sono por noite</label>
                <input id="horasSono" type="number" step="0.1" name="horasSono" placeholder="Horas de sono por noite" />
            </div>
            <div class="form-field">
                <label for="nivelAtividade">Nível de atividade física atual</label>
                <input id="nivelAtividade" type="text" name="nivelAtividade" placeholder="Nível de atividade física atual" />
            </div>
            <div class="form-field">
                <label for="tiposExercicio">Tipos de exercício que pratica ou já praticou</label>
                <input id="tiposExercicio" type="text" name="tiposExercicio" placeholder="Tipos de exercício que pratica ou já praticou" />
            </div>
            <div class="form-field">
                <label for="frequenciaTreinos">Frequência de treinos pretendida</label>
                <input id="frequenciaTreinos" type="text" name="frequenciaTreinos" placeholder="Frequência de treinos pretendida" />
            </div>
            <div class="form-field">
                <label for="agua">Consome água com frequência? (litros/dia)</label>
                <input id="agua" type="text" name="agua" placeholder="Consome água com frequência? (litros/dia)" />
            </div>
            <div class="form-field">
                <label for="tempoObjetivos">Em quanto tempo gostaria de alcançar seus objetivos?</label>
                <input id="tempoObjetivos" type="text" name="tempoObjetivos" placeholder="Em quanto tempo gostaria de alcançar seus objetivos?" />
            </div>
            <div class="form-field">
                <label for="dispostoMudanca">Está disposto(a) a mudar hábitos alimentares e de treino?</label>
                <input id="dispostoMudanca" type="text" name="dispostoMudanca" placeholder="Está disposto(a) a mudar hábitos alimentares e de treino?" />
            </div>
            <div class="form-field" style="grid-column: span 2;">
                <label for="comentarios">Qualquer comentário ou observação que queira fazer</label>
                <textarea id="comentarios" name="comentarios" placeholder="Qualquer comentário ou observação que queira fazer"></textarea>
            </div>
            <div class="form-actions">
                <button type="button" id="voltar">Voltar</button>
                <button type="button" id="importarPlanilha">Importar do Google Sheets</button>
                <button type="submit">Salvar</button>
            </div>
        </form>
        <div id="mensagemAnamnese"></div>
    </div>
    <script type="module">
        import { fetchWithFreshToken } from './js/auth.js';

        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        const form = document.getElementById('anamneseForm');
        const msg = document.getElementById('mensagemAnamnese');

        document.getElementById('voltar').addEventListener('click', () => {
            window.location.href = `nova_avaliacao.html?id=${id}`;
        });

        document.getElementById('importarPlanilha').addEventListener('click', async () => {
            if (!form.email || !form.email.value) {
                msg.textContent = 'Preencha o email para importar';
                return;
            }
            try {
                const res = await fetchWithFreshToken(`http://localhost:3000/users/alunos/${id}/anamnese/sheet?email=${encodeURIComponent(form.email.value)}`);
                if (res.ok) {
                    const data = await res.json();
                    if (data) {
                        Object.keys(data).forEach(k => { if (form[k]) form[k].value = data[k]; });
                        msg.textContent = 'Dados importados do Google Sheets';
                    } else {
                        msg.textContent = 'Nenhum dado encontrado no Google Sheets';
                    }
                } else {
                    msg.textContent = 'Erro ao importar dados';
                }
            } catch (err) {
                console.error('Erro ao importar planilha:', err);
                msg.textContent = 'Erro ao importar planilha';
            }
        });

        form.addEventListener('submit', async e => {
            e.preventDefault();
            const dados = {};
            Array.from(form.elements).forEach(el => { if (el.name) dados[el.name] = el.value; });
            try {
                const res = await fetchWithFreshToken(`http://localhost:3000/users/alunos/${id}/anamnese`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });
                msg.textContent = res.ok ? 'Anamnese salva' : 'Erro ao salvar anamnese';
            } catch (err) {
                console.error('Erro ao salvar anamnese:', err);
                msg.textContent = 'Erro ao salvar anamnese';
            }
        });

        async function carregar() {
            if (!id) return;
            try {
                const alunoRes = await fetchWithFreshToken(`http://localhost:3000/users/alunos/${id}`);
                if (alunoRes.ok) {
                    const aluno = await alunoRes.json();
                    if (form.nome) form.nome.value = aluno.nome || '';
                    if (form.email) form.email.value = aluno.email || '';
                }
                const res = await fetchWithFreshToken(`http://localhost:3000/users/alunos/${id}/anamnese`);
                if (res.ok) {
                    const data = await res.json();
                    if (data) {
                        Object.keys(data).forEach(k => { if (form[k]) form[k].value = data[k]; });
                    }
                }
            } catch (err) {
                console.error('Erro ao carregar anamnese:', err);
            }
        }

        document.addEventListener('DOMContentLoaded', carregar);
    </script>
</body>
</html>
