<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Visualizar Avaliação</title>
    <link rel="stylesheet" href="./css/styles.css" />
    <link rel="stylesheet" href="./css/dashboard.css" />
    <link rel="apple-touch-icon" sizes="180x180" href="/public/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/public/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/public/img/favicon-16x16.png">
    <link rel="manifest" href="/public/img/site.webmanifest">
</head>
<body>
    <div class="avaliacao-container">
        <h2>Avaliação</h2>
        <div id="dadosAvaliacao"></div>
        <div class="form-actions">
            <button type="button" id="editar">Editar</button>
            <button type="button" id="excluir">Excluir</button>
            <button type="button" id="voltar">Voltar</button>
        </div>
    </div>
    <script type="module">
        import { deleteEvaluation, getEvaluation } from './js/evaluationsApi.js';

        function formatDate(value) {
            if (!value) return '-';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return '-';
            return date.toLocaleDateString('pt-BR');
        }

        function escapeHtml(value) {
            return String(value ?? '').replace(/[&<>"']/g, match => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            })[match]);
        }

        function renderSection(title, data) {
            if (!data || typeof data !== 'object') return '';
            const fields = Object.entries(data).map(([key, value]) => `
                <div><strong>${escapeHtml(key)}:</strong> ${escapeHtml(value)}</div>
            `).join('');
            if (!fields) return '';
            return `
                <div class="avaliacao-part">
                    <h3>${escapeHtml(title)}</h3>
                    <div class="avaliacao-grid">${fields}</div>
                </div>
            `;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const alunoId = params.get('alunoId');
            const avaliacaoId = params.get('avaliacaoId');
            const container = document.getElementById('dadosAvaliacao');
            if (!alunoId || !avaliacaoId) {
                container.textContent = 'Avaliação não encontrada';
                return;
            }

            try {
                const avaliacao = await getEvaluation(alunoId, avaliacaoId);
                if (!avaliacao) {
                    container.textContent = 'Avaliação não encontrada';
                    return;
                }

                const sections = avaliacao.sections || {};
                const sectionOrder = [
                    ['anamnese', 'Anamnese'],
                    ['composicao', 'Composição Corporal'],
                    ['perimetria', 'Perimetria'],
                    ['flexibilidade', 'Flexibilidade'],
                    ['postural', 'Postural']
                ];

                const sectionsHtml = sectionOrder
                    .map(([key, label]) => renderSection(label, sections[key]))
                    .join('');

                container.innerHTML = `
                    <div class="avaliacao-grid">
                        <div><strong>Data:</strong> ${formatDate(avaliacao.completedAt || avaliacao.createdAt)}</div>
                        <div><strong>Próxima Avaliação:</strong> ${formatDate(avaliacao.nextEvaluationAt)}</div>
                        <div><strong>Status:</strong> ${escapeHtml(avaliacao.status || '—')}</div>
                    </div>
                    ${sectionsHtml || '<p>Sem dados adicionais para esta avaliação.</p>'}
                `;

                document.getElementById('editar').addEventListener('click', () => {
                    const editParams = new URLSearchParams();
                    editParams.set('id', alunoId);
                    editParams.set('avaliacao', avaliacaoId);
                    window.location.href = `nova_avaliacao.html?${editParams.toString()}`;
                });

                document.getElementById('excluir').addEventListener('click', async () => {
                    if (!confirm('Deseja excluir esta avaliação?')) return;
                    try {
                        await deleteEvaluation(alunoId, avaliacaoId);
                        window.location.href = 'dashboard.html?section=avaliacoes';
                    } catch (err) {
                        console.error('Erro ao excluir avaliação:', err);
                        alert('Não foi possível excluir a avaliação.');
                    }
                });
            } catch (err) {
                console.error('Erro ao carregar avaliação:', err);
                container.textContent = 'Não foi possível carregar a avaliação';
            }

            document.getElementById('voltar').addEventListener('click', () => window.history.back());
        });
    </script>
</body>
</html>
