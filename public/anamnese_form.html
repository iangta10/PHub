<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Anamnese</title>
    <link rel="stylesheet" href="./css/styles.css" />
    <link rel="stylesheet" href="./css/dashboard.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet" />
    <link rel="apple-touch-icon" sizes="180x180" href="/public/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/public/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/public/img/favicon-16x16.png">
    <link rel="manifest" href="/public/img/site.webmanifest">
</head>
<body>
    <div class="avaliacao-container">
        <header class="avaliacao-header">
            <h2>Anamnese</h2>
            <section class="aluno-info" aria-label="Informações do aluno">
                <div class="aluno-info-item">
                    <span class="aluno-info-label">Nome</span>
                    <span class="aluno-info-value" data-aluno-nome></span>
                </div>
                <div class="aluno-info-item">
                    <span class="aluno-info-label">Idade</span>
                    <span class="aluno-info-value" data-aluno-idade></span>
                </div>
                <div class="aluno-info-item">
                    <span class="aluno-info-label">Gênero</span>
                    <span class="aluno-info-value" data-aluno-genero></span>
                </div>
            </section>
        </header>
        <form id="anamneseForm" class="avaliacao-grid">
            <div class="form-section">
                <h3>Objetivos e treino</h3>
                <div class="form-section-grid">
                    <div class="form-field full-width">
                        <label for="objetivos">Objetivos</label>
                        <textarea id="objetivos" name="objetivos" placeholder="Objetivos"></textarea>
                    </div>
                    <div class="form-field">
                        <label for="frequenciaTreinos">Frequência de treinos pretendida</label>
                        <input id="frequenciaTreinos" type="text" name="frequenciaTreinos" placeholder="Frequência de treinos pretendida" />
                    </div>
                    <div class="form-field">
                        <label for="nivelAtividade">Nível de atividade física atual</label>
                        <input id="nivelAtividade" type="text" name="nivelAtividade" placeholder="Nível de atividade física atual" />
                    </div>
                    <div class="form-field">
                        <label for="tiposExercicio">Tipos de exercício que pratica ou já praticou</label>
                        <input id="tiposExercicio" type="text" name="tiposExercicio" placeholder="Tipos de exercício que pratica ou já praticou" />
                    </div>
                    <div class="form-field">
                        <label for="tempoObjetivos">Em quanto tempo gostaria de alcançar seus objetivos?</label>
                        <input id="tempoObjetivos" type="text" name="tempoObjetivos" placeholder="Em quanto tempo gostaria de alcançar seus objetivos?" />
                    </div>
                    <div class="form-field">
                        <label for="dispostoMudanca">Está disposto(a) a mudar hábitos alimentares e de treino?</label>
                        <input id="dispostoMudanca" type="text" name="dispostoMudanca" placeholder="Está disposto(a) a mudar hábitos alimentares e de treino?" />
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>Histórico de saúde</h3>
                <div class="form-section-grid">
                    <div class="form-field full-width">
                        <label for="doencas">Já teve ou tem alguma doença? Se sim, quais?</label>
                        <textarea id="doencas" name="doencas" placeholder="Já teve ou tem alguma doença? Se sim, quais?"></textarea>
                    </div>
                    <div class="form-field full-width">
                        <label for="doencasFamilia">Alguém da família tem alguma doença? Se sim, quais?</label>
                        <textarea id="doencasFamilia" name="doencasFamilia" placeholder="Alguém da família tem alguma doença? Se sim, quais?"></textarea>
                    </div>
                    <div class="form-field full-width">
                        <label for="medicamentos">Faz uso de medicamentos? Quais?</label>
                        <textarea id="medicamentos" name="medicamentos" placeholder="Faz uso de medicamentos? Quais?"></textarea>
                    </div>
                    <div class="form-field full-width">
                        <label for="cirurgias">Já passou por cirurgias? Quais?</label>
                        <textarea id="cirurgias" name="cirurgias" placeholder="Já passou por cirurgias? Quais?"></textarea>
                    </div>
                    <div class="form-field full-width">
                        <label for="doresLesoes">Possui dores ou lesões?</label>
                        <textarea id="doresLesoes" name="doresLesoes" placeholder="Possui dores ou lesões?"></textarea>
                    </div>
                    <div class="form-field full-width">
                        <label for="limitacoes">Alguma limitação para exercícios físicos?</label>
                        <textarea id="limitacoes" name="limitacoes" placeholder="Alguma limitação para exercícios físicos?"></textarea>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>Hábitos e rotina</h3>
                <div class="form-section-grid">
                    <div class="form-field">
                        <label for="fuma">Você fuma?</label>
                        <input id="fuma" type="text" name="fuma" placeholder="Você fuma?" />
                    </div>
                    <div class="form-field">
                        <label for="bebe">Você bebe? Se sim, com qual frequência?</label>
                        <input id="bebe" type="text" name="bebe" placeholder="Você bebe? Se sim, com qual frequência?" />
                    </div>
                    <div class="form-field">
                        <label for="qualidadeSono">Qualidade do sono</label>
                        <input id="qualidadeSono" type="text" name="qualidadeSono" placeholder="Qualidade do sono" />
                    </div>
                    <div class="form-field">
                        <label for="horasSono">Horas de sono por noite</label>
                        <input id="horasSono" type="number" step="0.1" name="horasSono" placeholder="Horas de sono por noite" />
                    </div>
                    <div class="form-field">
                        <label for="agua">Consome água com frequência? (litros/dia)</label>
                        <input id="agua" type="text" name="agua" placeholder="Consome água com frequência? (litros/dia)" />
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>Observações</h3>
                <div class="form-section-grid">
                    <div class="form-field full-width">
                        <label for="comentarios">Qualquer comentário ou observação que queira fazer</label>
                        <textarea id="comentarios" name="comentarios" placeholder="Qualquer comentário ou observação que queira fazer"></textarea>
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" id="voltar">Voltar</button>
                <button type="button" id="importarPlanilha">Importar do Google Sheets</button>
                <button type="submit">Salvar</button>
            </div>
        </form>
        <div id="mensagemAnamnese"></div>
    </div>
    <script type="module">
        import { fetchWithFreshToken } from './js/auth.js';

        const params = new URLSearchParams(window.location.search);
        const id = params.get('id');
        const form = document.getElementById('anamneseForm');
        const msg = document.getElementById('mensagemAnamnese');
        const alunoInfoEls = {
            nome: document.querySelector('[data-aluno-nome]'),
            idade: document.querySelector('[data-aluno-idade]'),
            genero: document.querySelector('[data-aluno-genero]')
        };
        let alunoEmail = '';

        function calcularIdade(dataNascimento) {
            if (!dataNascimento) return '';
            const nasc = new Date(dataNascimento);
            if (Number.isNaN(nasc.getTime())) return '';
            const hoje = new Date();
            let idade = hoje.getFullYear() - nasc.getFullYear();
            const mes = hoje.getMonth() - nasc.getMonth();
            if (mes < 0 || (mes === 0 && hoje.getDate() < nasc.getDate())) {
                idade--;
            }
            return idade >= 0 ? idade : '';
        }

        function atualizarAlunoInfo(aluno) {
            const genero = aluno ? (aluno.genero || aluno.sexo || '') : '';
            const idadeValor = aluno ? (aluno.idade || calcularIdade(aluno.dataNascimento)) : '';
            if (alunoInfoEls.nome) alunoInfoEls.nome.textContent = aluno?.nome || '';
            if (alunoInfoEls.idade) alunoInfoEls.idade.textContent = idadeValor ? `${idadeValor} anos` : '';
            if (alunoInfoEls.genero) alunoInfoEls.genero.textContent = genero || '';
        }

        document.getElementById('voltar').addEventListener('click', () => {
            window.location.href = `nova_avaliacao.html?id=${id}`;
        });

        document.getElementById('importarPlanilha').addEventListener('click', async () => {
            if (!alunoEmail) {
                msg.textContent = 'Não há e-mail cadastrado para importação.';
                return;
            }
            try {
                const res = await fetchWithFreshToken(`/api/users/alunos/${id}/anamnese/sheet?email=${encodeURIComponent(alunoEmail)}`);
                if (res.ok) {
                    const data = await res.json();
                    if (data) {
                        Object.keys(data).forEach(k => { if (form[k]) form[k].value = data[k]; });
                        msg.textContent = 'Dados importados do Google Sheets';
                    } else {
                        msg.textContent = 'Nenhum dado encontrado no Google Sheets';
                    }
                } else {
                    msg.textContent = 'Erro ao importar dados';
                }
            } catch (err) {
                console.error('Erro ao importar planilha:', err);
                msg.textContent = 'Erro ao importar planilha';
            }
        });

        form.addEventListener('submit', async e => {
            e.preventDefault();
            const dados = {};
            Array.from(form.elements).forEach(el => { if (el.name) dados[el.name] = el.value; });
            const avalId = localStorage.getItem(`currentAvalId_${id}`);
            try {
                const res = await fetchWithFreshToken(`/api/users/alunos/${id}/anamnese`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });
                msg.textContent = res.ok ? 'Anamnese salva' : 'Erro ao salvar anamnese';
                if (res.ok) {
                    if (avalId) localStorage.setItem(`avaliacao_${id}_${avalId}_anamnese`, JSON.stringify(dados));
                    window.location.href = `nova_avaliacao.html?id=${id}`;
                }
            } catch (err) {
                console.error('Erro ao salvar anamnese:', err);
                msg.textContent = 'Erro ao salvar anamnese';
            }
        });

        async function carregar() {
            atualizarAlunoInfo(null);
            if (!id) return;
            try {
                const alunoRes = await fetchWithFreshToken(`/api/users/alunos/${id}`);
                if (alunoRes.ok) {
                    const aluno = await alunoRes.json();
                    alunoEmail = aluno.email || '';
                    atualizarAlunoInfo(aluno);
                    if (form.nome) form.nome.value = aluno.nome || '';
                    if (form.email) form.email.value = aluno.email || '';
                    const genero = aluno.genero || aluno.sexo || '';
                    if (form.genero) form.genero.value = genero;
                    const idade = aluno.idade || calcularIdade(aluno.dataNascimento);
                    if (form.idade) form.idade.value = idade || '';
                } else {
                    atualizarAlunoInfo(null);
                }
                const res = await fetchWithFreshToken(`/api/users/alunos/${id}/anamnese`);
                if (res.ok) {
                    const data = await res.json();
                    if (data) {
                        Object.keys(data).forEach(k => { if (form[k]) form[k].value = data[k]; });
                    }
                }
                const avalId = localStorage.getItem(`currentAvalId_${id}`);
                if (avalId) {
                    const local = localStorage.getItem(`avaliacao_${id}_${avalId}_anamnese`);
                    if (local) {
                        const obj = JSON.parse(local);
                        Object.keys(obj).forEach(k => { if (form[k]) form[k].value = obj[k]; });
                    }
                }
            } catch (err) {
                console.error('Erro ao carregar anamnese:', err);
            }
        }

        document.addEventListener('DOMContentLoaded', carregar);
    </script>
</body>
</html>
